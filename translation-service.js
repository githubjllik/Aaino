class TranslationService {
    constructor() {
        this.currentLanguage = localStorage.getItem('selectedLanguage') || 'fr';
        this.translations = {};
        this.initialize();
        this.loadTranslations();
    }

    initialize() {
        const langSelector = document.getElementById('language-selector');
        const currentLangBtn = document.getElementById('current-language');
        const dropdown = document.getElementById('language-dropdown');
        const options = document.querySelectorAll('.language-option');

        this.updateCurrentLanguageDisplay();

        currentLangBtn.addEventListener('click', () => {
            dropdown.classList.toggle('show');
        });

        options.forEach(option => {
            option.addEventListener('click', () => {
                const newLang = option.dataset.lang;
                this.setLanguage(newLang);
                dropdown.classList.remove('show');
            });
        });

        document.addEventListener('click', (e) => {
            if (!langSelector.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        this.setupMutationObserver();
    }

    setupMutationObserver() {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.addedNodes.length) {
                    this.translatePage();
                }
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    async loadTranslations() {
        const textNodes = this.getAllTextNodes(document.body);
        const textsToTranslate = new Set();

        textNodes.forEach(node => {
            const text = node.textContent.trim();
            if (text) textsToTranslate.add(text);
        });

        for (const text of textsToTranslate) {
            if (!this.translations[text]) {
                this.translations[text] = {};
                for (const lang of ['en', 'es', 'de']) {
                    try {
                        const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=fr&tl=${lang}&dt=t&q=${encodeURIComponent(text)}`);
                        const data = await response.json();
                        const translatedText = data[0].map(item => item[0]).join('');
                        this.translations[text][lang] = translatedText;
                    } catch (error) {
                        console.error('Translation error:', error);
                        this.translations[text][lang] = text;
                    }
                }
            }
        }
    }

    getAllTextNodes(element) {
    const textNodes = [];
    
    // Pour les n≈ìuds de texte normaux
    const walk = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        {
            acceptNode: function(node) {
                if (node.parentElement.tagName === 'SCRIPT' || 
                    node.parentElement.tagName === 'STYLE' ||
                    node.parentElement.id === 'language-selector' ||
                    node.parentElement.classList.contains('language-option')) {
                    return NodeFilter.FILTER_REJECT;
                }
                return node.textContent.trim() ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
            }
        }
    );

    let node;
    while (node = walk.nextNode()) {
        textNodes.push(node);
    }

    // Pour les placeholders
    element.querySelectorAll('input[placeholder], textarea[placeholder]').forEach(input => {
        const placeholder = input.getAttribute('placeholder');
        if (placeholder) {
            // Cr√©er un n≈ìud de texte virtuel pour le placeholder
            const virtualNode = {
                textContent: placeholder,
                parentElement: input,
                isPlaceholder: true  // Marquer comme placeholder pour le traitement ult√©rieur
            };
            textNodes.push(virtualNode);
        }
    });

    return textNodes;
}


    updateCurrentLanguageDisplay() {
            const flagMap = {
        'fr': 'üá´üá∑',
        'en': 'üá¨üáß',
        'es': 'üá™üá∏',
        'de': 'üá©üá™',
        'zh': 'üá®üá≥',
        'hi': 'üáÆüá≥',
        'ar': 'üá∏üá¶',
        'ru': 'üá∑üá∫',
        'ja': 'üáØüáµ',
        'sw': 'üáπüáø',
        'tr': 'üáπüá∑',
        'te': 'üáÆüá≥',
        'bn': 'üáßüá©',
        'ko': 'üá∞üá∑',
        'tl': 'üáµüá≠',
        'yo': 'üá≥üá¨',
        'uk': 'üá∫üá¶',
        'ha': 'üá≥üá¨',
        'pt': 'üáµüáπ',
        'it': 'üáÆüáπ',
        'ht': 'üá≠üáπ',
        'my': 'üá≤üá≤',
    'nl': 'üá≥üá±',
    'vi': 'üáªüá≥',
    'th': 'üáπüá≠',
    'fa': 'üáÆüá∑',
    'el': 'üá¨üá∑',
    'ro': 'üá∑üá¥',
    'hu': 'üá≠üá∫',
    'cs': 'üá®üáø',
    'pl': 'üáµüá±',
    'he': 'üáÆüá±',
    'ms': 'üá≤üáæ',
    'id': 'üáÆüá©',
    'am': 'üá™üáπ',
    'ur': 'üáµüá∞',
    'mr': 'üáÆüá≥',
    'ta': 'üá±üá∞'
    };
    
    const nameMap = {
        'fr': 'Fran√ßais',
        'en': 'English',
        'es': 'Espa√±ol',
        'de': 'Deutsch',
        'zh': '‰∏≠Êñá',
        'hi': '‡§π‡§ø‡§Ç‡§¶‡•Ä',
        'ar': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
        'ru': '–†—É—Å—Å–∫–∏–π',
        'ja': 'Êó•Êú¨Ë™û',
        'sw': 'Kiswahili',
        'tr': 'T√ºrk√ße',
        'te': '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å',
        'bn': '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ',
        'ko': 'ÌïúÍµ≠Ïñ¥',
        'tl': 'Tagalog',
        'yo': 'Yor√πb√°',
        'uk': '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞',
        'ha': 'Hausa',
        'pt': 'Portugu√™s',
        'it': 'Italiano',
        'ht': 'Krey√≤l',
        'my': '·Äô·Äº·Äî·Ä∫·Äô·Ä¨·ÄÖ·Ä¨',
    'nl': 'Nederlands',
    'vi': 'Ti·∫øng Vi·ªát',
    'th': '‡πÑ‡∏ó‡∏¢',
    'fa': 'ŸÅÿßÿ±ÿ≥€å',
    'el': 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨',
    'ro': 'Rom√¢nƒÉ',
    'hu': 'Magyar',
    'cs': 'ƒåe≈°tina',
    'pl': 'Polski',
    'he': '◊¢◊ë◊®◊ô◊™',
    'ms': 'Bahasa Melayu',
    'id': 'Bahasa Indonesia',
    'am': '·ä†·àõ·à≠·äõ',
    'ur': 'ÿßÿ±ÿØŸà',
    'mr': '‡§Æ‡§∞‡§æ‡§†‡•Ä',
    'ta': '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç'
    };

        
        document.getElementById('current-language-flag').textContent = flagMap[this.currentLanguage];
        document.getElementById('current-language-text').textContent = nameMap[this.currentLanguage];
    }

    setLanguage(lang) {
    this.currentLanguage = lang;
    localStorage.setItem('selectedLanguage', lang);
    this.updateCurrentLanguageDisplay();
    location.reload(); // Ajouter cette ligne pour recharger la page
}


    async translatePage() {
    if (this.currentLanguage === 'fr') {
        this.restoreOriginalContent();
        return;
    }

    const textNodes = this.getAllTextNodes(document.body);
    
    for (const node of textNodes) {
        const originalText = node.textContent.trim();
        if (originalText) {
            const parentElement = node.parentElement;
            
            if (node.isPlaceholder) {
                // Traitement des placeholders
                if (!parentElement.hasAttribute('data-original-placeholder')) {
                    parentElement.setAttribute('data-original-placeholder', originalText);
                    
                    if (this.translations[originalText] && this.translations[originalText][this.currentLanguage]) {
                        parentElement.setAttribute('placeholder', this.translations[originalText][this.currentLanguage]);
                    } else {
                        try {
                            const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=fr&tl=${this.currentLanguage}&dt=t&q=${encodeURIComponent(originalText)}`);
                            const data = await response.json();
                            const translatedText = data[0].map(item => item[0]).join('');
                            this.translations[originalText] = this.translations[originalText] || {};
                            this.translations[originalText][this.currentLanguage] = translatedText;
                            parentElement.setAttribute('placeholder', translatedText);
                        } catch (error) {
                            console.error('Translation error:', error);
                        }
                    }
                }
            } else {
                // Traitement normal des n≈ìuds de texte
                if (!parentElement.hasAttribute('data-original')) {
                    parentElement.setAttribute('data-original', originalText);
                    
                    if (this.translations[originalText] && this.translations[originalText][this.currentLanguage]) {
                        node.textContent = this.translations[originalText][this.currentLanguage];
                    } else {
                        try {
                            const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=fr&tl=${this.currentLanguage}&dt=t&q=${encodeURIComponent(originalText)}`);
                            const data = await response.json();
                            const translatedText = data[0].map(item => item[0]).join('');
                            this.translations[originalText] = this.translations[originalText] || {};
                            this.translations[originalText][this.currentLanguage] = translatedText;
                            node.textContent = translatedText;
                        } catch (error) {
                            console.error('Translation error:', error);
                        }
                    }
                }
            }
        }
    }
}


    restoreOriginalContent() {
        document.querySelectorAll('[data-original]').forEach(element => {
            const originalText = element.getAttribute('data-original');
            // Trouve le n≈ìud de texte direct et met √† jour son contenu
            const textNode = Array.from(element.childNodes).find(node => node.nodeType === 3);
            if (textNode) {
                textNode.textContent = originalText;
            }
        });
    }

    async translateSearchQuery(query) {
        if (this.currentLanguage === 'fr') return query;
        
        try {
            const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=fr&dt=t&q=${encodeURIComponent(query)}`);
            const data = await response.json();
            return data[0].map(item => item[0]).join('');
        } catch (error) {
            console.error('Translation error:', error);
            return query;
        }
    }
}

// Initialiser le service de traduction
const translationService = new TranslationService();
